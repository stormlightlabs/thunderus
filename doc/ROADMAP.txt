*ROADMAP.txt*                                       Coding Agent (Thunderus) MVP

CODING AGENT MVP                                                 *agent-harness*
================================================================================
See |VISION.txt| for design philosophy, core principles, and milestone targets.
--------------------------------------------------------------------------------
CONTENTS                                                      *roadmap-contents*
--------------------------------------------------------------------------------

     I. Repo Scaffold + Config + Session Store ................. |2026-01-12|
    II. Provider Harness...Execution Infrastructure ............ |2026-01-13|
   III. TUI Harness ............................................ |2026-01-15|
    IV. TUI + Agent + CLI Integration .......................... |2026-01-15|
     V. Core Text Processing Tools ............................. |2026-01-16|
    VI. Approvals + Sandboxing (Shell-First, Still Safe) ....... |2026-01-18|
   VII. Diff-First Editing + Git Integration ................... |2026-01-19|
  VIII. Theming / UI ........................................... |2026-01-20|
    IX. Markdown + JSONL Hybrid VCS ............................ |2026-01-21|
     X. TIERED MEMORY CORE + STORE ............................. |2026-01-22|
    XI. LONG-TERM MEMORY STORE + RETRIEVAL ..................... |2026-01-22|
   XII. MEMORY GARDENER  ....................................... |2026-01-23|
  XIII. TRAJECTORY + INSPECTOR ................................. |2026-01-23|
   XIV. MIXED-INITIATIVE COLLABORATION ......................... |2026-01-24|
    XV. PROVIDER COMPLETION + DEVELOPER TOOLING ................ |2026-01-26|
   XVI. EXTENSIBILITY .......................................... |agent-XVI|
  XVII. HARDENING .............................................. |agent-XVII|
 XVIII. TUI TESTING FRAMEWORK .................................. |agent-XVIII|
   XIX. LAYOUT ................................................. |agent-XIX|
    XX. PARKING LOT............................................. |agent-XX|
   XXI. UNIFIED LOGGING + OBSERVABILITY ........................ |agent-XXI|
  XXII. REFERENCES ............................................. |REFS.txt|

--------------------------------------------------------------------------------
XVI. EXTENSIBILITY (SKILLS + PLUGINS)                                *agent-XVI*
--------------------------------------------------------------------------------
Make Thunderus extensible via on-demand capabilities, runtime plugins, and
external tool protocols.

Phase 1: Skills System Enhancements
- [x] Skills system (on-demand capability loading):
      - `.thunderus/skills/` directory structure
      - SKILL.md format with frontmatter (name, description)
      - `/skill:name` invocation
      - Agent auto-discovery based on task intent
- [x] Enhanced SKILL.md format:
      - `driver` field: shell | wasm | lua | mcp
      - `permissions` block: filesystem (read/write globs), network (allowed_hosts)
      - `functions` array for multi-function plugins
      - `parameters` JSON Schema for tool invocation
- [x] Permission model (capability-based security):
      - `SkillPermissions` struct with filesystem/network controls
      - Path resolution with traversal protection
      - Permission checks in Host API layer

Phase 2: WASM Runtime (Extism)
- [x] WasmEngine using Extism (wraps Wasmtime):
      - Load `.wasm` files with manifest-based permissions
      - `allowed_hosts` for HTTP, `allowed_paths` for filesystem
      - Memory isolation by default
- [x] Host functions for WASM plugins:
      - `thunderus_log`, `thunderus_read_file`, `thunderus_write_file`
      - `thunderus_kv_get`, `thunderus_kv_set`
- [x] WasmTool adapter (surfaces as ToolDefinition)
- [x] Example Rust WASM plugin (compile with wasm32-wasip1)

Phase 3: Lua Runtime (mlua)
- [x] LuaEngine using mlua with Luau sandboxing:
      - Whitelist libraries: table, string, math, utf8
      - Block dangerous: dofile, loadfile, load, os, io
      - Isolated Lua state per plugin
- [x] Host API injection (`thunderus.*` globals)
- [x] LuaTool adapter (surfaces as ToolDefinition)
- [ ] Example Lua plugin

Phase 4: MCP Client
- [ ] McpClient crate (`crates/mcp/`):
      - stdio transport (spawn MCP server as subprocess)
      - SSE transport (connect to remote MCP server)
- [ ] Tool discovery from connected servers
- [ ] McpTool adapter (surfaces as ToolDefinition)
- [ ] Tool search mode (on-demand loading when tools > 10% context)
- [ ] Resource support (@ mentions)

Phase 5: Integration
- [ ] Update approval system for plugin risk levels
- [ ] Plugin hot-reload support
- [ ] Move web_search and fetch_url to skills
- [ ] Documentation and example plugins

DoD:
- SKILL.md supports `driver: wasm` and `driver: lua` fields.
- WasmEngine loads `.wasm` files; LuaEngine loads `.lua` with sandboxing.
- Host functions work in both runtimes with permission enforcement.
- MCP client can connect to servers and import tools.
- All plugin tools integrate with approval system.

--------------------------------------------------------------------------------
XVII. HARDENING (TESTS + EXEC MODE)                                 *agent-XVII*
--------------------------------------------------------------------------------
Make Thunderus production-ready with regression tests and automation support.

- [ ] Harness regression tests (golden scenarios):
      - interrupt mid-tool, drift+reconcile, patch conflict UI, approval gating
- [ ] Non-interactive mode (`thunderus exec "â€¦"`) like Codex's `exec`:
      - emits JSON (machine output) + writes JSONL session log[^3]
      - Exit codes for CI/CD integration
- [ ] "review agent" (second pass) like Codex `/review` flow[^3]:
      - Confidence scoring for changes
- [ ] Session-based teaching state:
      - persist "taught concepts" in session metadata
      - track which pedagogical hints have been shown
        (e.g., `taught: [patch_conflict, risky_command]`)
      - prevent repetitive hints across session lifecycle
      - expose teaching history in session events for debugging
- [ ] Error recovery:
      - Graceful degradation on tool failures
      - Automatic retry with backoff
      - User notification on repeated failures
- [ ] TUI enhancements:
      - Permissions pane in sidebar
      - toggle verbose action trace keybind

DoD:
- Test suite covers all critical paths; `exec` mode works reliably in CI.

--------------------------------------------------------------------------------
XVIII. TUI TESTING FRAMEWORK                                       *agent-XVIII*
--------------------------------------------------------------------------------
Ensure visual regression coverage and end-to-end stability for the TUI harness.
Prevent layout regressions and ensure the agent loop handles terminal events
correctly.

Tasks:
- [ ] Widget Snapshot Infrastructure:
      - Add `insta` dependency
      - Configure snapshot directory and CI checks
- [ ] Core Widget Component Tests:
      - Welcome Screen (static render)
      - Transcript Renderer (wrapping, colors)
      - Approval Panel (risk state UI)
- [ ] Behavioral Logic Tests:
      - Event handler (input -> action)
      - Session state transitions
- [ ] PTY Integration Tests (End-to-End):
      - Headless binary launch & quit
      - Resize handling smoke test

DoD:
- `cargo test` runs unit + snapshot tests.
- CI fails on unreviewed snapshot changes.
- At least 3 major widgets have golden snapshots.

--------------------------------------------------------------------------------
XIX. LAYOUT                                                          *agent-XIX*
--------------------------------------------------------------------------------
Implement the final "Opening" and "Agent" layouts based on designated design
artifacts, ensuring a premium, polished TUI experience.

Tasks:
- [x] Implement Opening Layout (see `doc/DESIGN.txt` |design-layout|):
      - Clean, focused entry point
- [x] Implement Agent Layouts (see `doc/DESIGN.txt` |design-layout|):
      - "Inspire actual agent" interactions
      - Sidebar / Context panels
- [x] Verify TUI responsiveness and styling matches design intent
- [x] Finalize `doc/DESIGN.txt` with observed patterns

DoD:
- UI matches the visual target of `doc/DESIGN.txt`.
- Spec and implementation overlap 100%.

--------------------------------------------------------------------------------
XX. PARKING LOT                                                      *agent-XX*
--------------------------------------------------------------------------------
Session Recovery:
- Interactive session selection UI (list multiple sessions with metadata)
- Session search and filtering (by date, keyword, etc.)
- Session branching (fork from a previous session)
- Session export/import (share sessions between machines)
- Session metadata (title, tags, description)

--------------------------------------------------------------------------------
XXI. UNIFIED LOGGING + OBSERVABILITY                                 *agent-XXI*
--------------------------------------------------------------------------------
Implement production-grade logging and observability using tracing ecosystem.
Inspired by Codex CLI logging support, LangSmith traces, and AI Observer
patterns.

See |.sandbox/LOGGING_SPEC.md| for full specification.

- [x] Unified subscriber (tracing-subscriber with layer stack):
      - EnvFilter from THUNDERUS_LOG (per-crate filtering)
      - fmt layer for stderr (pretty/json/compact formats)
      - JSON file layer for session logs
- [x] Structured event taxonomy:
      - Session events (start, end, resume)
      - Provider events (request, response, error, stream)
      - Tool events (dispatch, result, approval)
      - Agent events (turn start/end, thinking)
      - Memory events (store, retrieve, index)
- [x] Session-scoped tracing:
      - Root span per session (trace_id = session_id)
      - Nested spans for turns, tool calls, provider requests
      - Async span propagation with Instrument trait
- [x] Privacy controls:
      - Prompt content redaction by default
      - Configurable tool argument sanitization
      - Truncation for large outputs
- [x] Migrate existing debug module:
      - Convert debug_log! calls to tracing::debug!
      - Map DebugCategory to tracing targets
      - Remove custom debug module after migration

DoD:
- All crates instrument key operations with tracing.
- THUNDERUS_LOG controls verbosity; JSON logs written to session directory.

--------------------------------------------------------------------------------
XXII. REFERENCES                                                    *agent-XXII*
--------------------------------------------------------------------------------
See |REFS.txt| for external resources, design inspirations, and footnotes.
