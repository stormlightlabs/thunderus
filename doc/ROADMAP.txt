*ROADMAP.txt*                                       Coding Agent (Thunderus) MVP

CODING AGENT MVP                                                 *agent-harness*
================================================================================

See |VISION.txt| for design philosophy, core principles, and milestone targets.

--------------------------------------------------------------------------------
CONTENTS                                                      *roadmap-contents*
--------------------------------------------------------------------------------

    I. Repo Scaffold + Config + Session Store ................. |agent-I|
   II. Provider Harness...Execution Infrastructure ............ |agent-II|
  III. TUI Harness ............................................ |agent-III|
   IV. TUI + Agent + CLI Integration .......................... |agent-IV|
    V. Core Text Processing Tools ............................. |agent-V|
   VI. Approvals + Sandboxing (Shell-First, Still Safe) ....... |agent-VI|
  VII. Diff-First Editing + Git Integration ................... |agent-VII|
 VIII. Theming / UI ........................................... |agent-VIII|
   IX. Markdown + JSONL Hybrid VCS ............................ |agent-IX|
    X. TIERED MEMORY CORE + STORE ............................. |agent-X|
   XI. LONG-TERM MEMORY STORE + RETRIEVAL ..................... |agent-XI|
  XII. MEMORY GARDENER  ....................................... |agent-XII|
 XIII. TRAJECTORY + INSPECTOR ................................. |agent-XIII|
  XIV. MIXED-INITIATIVE COLLABORATION ......................... |agent-XIV|
   XV. EXTENSIBILITY + HARDENING .............................. |agent-XV|
  XVI. PARKING LOT............................................. |agent-XVI|

--------------------------------------------------------------------------------
I. REPO SCAFFOLD + CONFIG + SESSION STORE                              *agent-I*
--------------------------------------------------------------------------------

See section |2026-01-12| for changes made.

--------------------------------------------------------------------------------
II. PROVIDER HARNESS + MINIMAL INTERACTIVE TUI                        *agent-II*
--------------------------------------------------------------------------------

See section |2026-01-13| for changes made.

--------------------------------------------------------------------------------
III. TUI HARNESS                                                     *agent-III*
--------------------------------------------------------------------------------

See section |2026-01-15| for changes made.

--------------------------------------------------------------------------------
IV. TUI + AGENT + CLI INTEGRATION                                     *agent-IV*
--------------------------------------------------------------------------------

See section |2026-01-15| for changes made.

--------------------------------------------------------------------------------
V. CORE TEXT PROCESSING TOOLS                                          *agent-V*
--------------------------------------------------------------------------------

See section |2026-01-16| for changes made.

--------------------------------------------------------------------------------
VI. APPROVALS + SANDBOXING (SHELL-FIRST, STILL SAFE)                  *agent-VI*
--------------------------------------------------------------------------------

See section |2026-01-18| for changes made.

--------------------------------------------------------------------------------
VII. DIFF-FIRST EDITING + GIT INTEGRATION                            *agent-VII*
--------------------------------------------------------------------------------
Edits are *reviewable*, *reversible*, and *conflict-aware*.

Codex explicitly treats diffs and `git apply` failure modes as first-class
(e.g., `codex apply` exits non-zero if `git apply` fails). Mirror that rigor[^7]

- [x] Patch queue:
      - states: `PROPOSED → APPROVED → APPLIED` or `REJECTED`
      - patch objects store base snapshot id + target files + hunks
- [x] Diffing algorithm upgrade:
      - replace naive line-by-line diff with `imara-diff` crate
      - use Histogram algorithm for semantic code diffs
      - improves readability for moved/refactored code blocks
- [x] Unified diff generation contract for models:
      - patch-first is default; raw write is an escape hatch (heavily gated)
- [x] Apply engine:
      - try `git apply` (or equivalent) and detect conflicts
      - on failure: enter conflict UI instead of "forcing it"
- [x] Rollback/undo:
      - revert last applied patch (one keybind)
      - show `git diff` before/after
- [x] Git metadata linkage:
      - attach session pointers via git notes
      - show "this commit came from session X" in TUI
- [x] TUI enhancements:
      - Diff Queue pane with hunk navigation
      - next/prev hunk keybinds
      - approve/reject individual hunks
- [x] Hunk labeling with intent:
      - attach semantic labels to hunks
        (e.g., "Add error handling", "Remove deprecated fn")
      - Pattern-based intent extraction (HunkLabeler in thunderus-tools)
      - Patch::label_hunks() method for automatic labeling
      - display intent above each hunk in diff view
      - teach version control discipline through consistent labeling
- [x] Pedagogical conflict messages:
      - on `git apply` failure, explain *why* conflict occurred
        (not just "conflict detected")
      - show conflicting regions with context
      - suggest resolution strategies (rebase, manual merge, discard)
      - first conflict triggers brief explainer on 3-way merge

DoD:
- "PR-stack feel" inside a TUI: accept hunks, undo safely, never lose work.

--------------------------------------------------------------------------------
VIII. UI POLISH + THEMING                                           *agent-VIII*
--------------------------------------------------------------------------------
Complete the design spec implementation and fix broken UI components.

Design target:
Match DESIGN.txt specifications for all UI components. Simple theme toggle b/t
Iceberg (default) and Oxocarbon.

P0: Exit Behavior
-----------------
- [x] Ctrl+D global exit:
      - BROKEN: only exits when input buffer empty
      - Required: global exit like zsh, claude, cursor, other CLI agents
      - Change: remove conditional, always return Exit action
- [x] Ctrl+C double-press with feedback:
      - Keep double-press behavior for safety
      - After first press: show "Press Ctrl+C again to exit" in footer

P0: Background Fills
---------------------
ALL components are missing their DESIGN.txt background colors:

- [x] Header background: #1e2132
- [x] Footer background: #1e2132
- [x] Sidebar background: #1e2132
- [x] Transcript background: #161821
- [x] Welcome screen backgrounds:
      - Main area: #161821
      - Panel box: #1e2132

P1: Message Styling
-------------------
Current: Plain text with prefix "You:" and "Agent:"
Required: Styled bubbles with backgrounds

- [x] User message bubbles:
      - Background: #272c42 (highlight)
      - Padding: 1 line vertical, 2 chars horizontal
      - Max width: 60 cols in centered view
- [x] Assistant message bubbles:
      - Background: #1e2132 (secondary)
      - Same padding requirements
- [x] Footer hints during generation:
      - Missing: [Ctrl+C: cancel]
      - Current: only shows "Esc: cancel"

P2: Medium Priority (Polish)
----------------------------
- [x] Scrollbar indicator:
      - Thin dim indicator on right edge of transcript
      - Color: #6b7089
- [x] Streaming ellipsis animation:
      - Animated "..." in dim color
      - Current: static "(streaming...)" text
- [x] Token usage format:
      - Current sidebar shows "In: X Out: Y"
      - DESIGN.txt shows "X.Xk / YYYk"
- [x] Compact tool cards
- [x] First-time hints: TeachingHintPopup
- [x] Sidebar navigation: [ and ] keys work

P3: Low Priority
-----------------
- [x] Remove emoji -> replace with Unicode characters if possible
- [x] Pulsing border animation for risky approval cards
- [x] Blinking cursor on [y] option
- [x] Sidebar slide animation on toggle

Theme Architecture
-------------------
Goal: Toggle between Iceberg (current) and Oxocarbon.

- [x] ThemeVariant enum:
      - Iceberg (default) - bluish dark from iceberg.vim
      - Oxocarbon - IBM Carbon-inspired grays/blues
- [x] Theme color functions with variant parameter
- [x] Ctrl+T keybind to toggle theme
- [x] Persist theme choice in profile config

Iceberg vs Oxocarbon:

│ Color    │ Iceberg     │ Oxocarbon   │
├──────────┼─────────────┼─────────────┤
│ BG       │ #161821   │ #161616   │
│ Panel    │ #1e2132   │ #262626   │
│ Highlight│ #272c42   │ #393939   │
│ FG       │ #c6c8d1   │ #f2f4f8   │
│ Muted    │ #6b7089   │ #525252   │

--------------------------------------------------------------------------------
IX. MARKDOWN + JSONL HYBRID VCS                                      *agent-IX*
--------------------------------------------------------------------------------
Your hybrid system is the canonical record of agent work, and it improves
collaboration and debugging.

- [ ] JSONL event model (append-only) in `events.jsonl`:
      - user msgs, model msgs, tool calls/results, approvals, patches,
      - shell outputs (by reference), git snapshots
- [ ] Materialized Markdown views:
      - `MEMORY.md` (always-loaded "project memory", Claude-style)
      - `PLAN.md` (current plan + checkpoints)
      - `DECISIONS.md` (ADR-lite)[^1]
- [ ] "CLAUDE.md compatibility":
      - if repo has `CLAUDE.md`, import it into context automatically because
        Claude Code uses it as auto-context[^1]
- [ ] View materializer:
      - deterministic regeneration from JSONL + explicit user edits logged as
        events
- [ ] Fast search:
      - ripgrep recipes surfaced in-app for events + views
- [ ] TUI enhancements (moved from Section III):
      - Context pane with view content
      - Files pane for file system browsing
      - `/plan`, `/review`, `/memory` slash commands
      - `@` file search in composer

DoD:
- You can reconstruct *exactly* what happened in a session and why.

--------------------------------------------------------------------------------
X. TIERED MEMORY CORE + STORE (REPO-NATIVE, AUDITABLE)          *agent-X*
--------------------------------------------------------------------------------
Goal:
Establish durable “external memory” that survives context limits and restarts,
while staying reviewable + git-friendly. Use a tiered design:
- Core memory: small, always-loaded
- Recall/Episodic: append-only session history + session recaps
- Semantic/Procedural: curated, reusable knowledge

Tasks:
- [ ] Define memory directory layout (repo-local, deterministic):
      - `.thunderus/memory/`
          - `core/`        (always loaded)
          - `semantic/`    (facts + ADR-lite)
          - `procedural/`  (playbooks)
          - `episodic/`    (session recaps)
          - `indexes/`     (manifests + search indexes)
- [ ] Core memory contract:
      - Small + stable (linted size caps; enforce headings; diffable)
      - Add:
          - `.thunderus/memory/core/CORE.md`
          - `.thunderus/memory/core/CORE.local.md` (gitignored)
      - Implement hierarchical load precedence (repo root → cwd):
          - merge + override rules documented in CORE.md
- [ ] Semantic memory contract:
      - `.thunderus/memory/semantic/DECISIONS/ADR-xxxx.md` (ADR-lite)
      - `.thunderus/memory/semantic/FACTS/*.md` (stable facts)
- [ ] Procedural memory contract:
      - `.thunderus/memory/procedural/PLAYBOOKS/*.md`
      - Each playbook: Preconditions, Steps, Verification, Rollback
- [ ] Memory writes are patch-driven:
      - memory updates are proposed as diffs in the patch queue
      - memory edits MUST be logged as VCS events (see VIII “events.jsonl”)

See |SCHEMAS.txt| section |schemas-memory-doc| for format specifications.

DoD:
- `.thunderus/memory/` exists with the required subtrees + lint rules.
- Memory docs are diffable, patch-driven, and always point back to provenance.

--------------------------------------------------------------------------------
XI. LONG-TERM MEMORY + RETRIEVAL (LEXICAL FIRST, VECTORS OPT-IN)      *agent-XI*
--------------------------------------------------------------------------------
Goal:
Make the agent reliably find the right memory at the right time without stuffing
everything into context. Default to lexical retrieval; optionally augment with
vector similarity later.

Tasks:
- [ ] Implement MemoryStore interface (backend: SQLite recommended):
      - put(namespace, key, content, metadata)
      - get(namespace, key)
      - search(query, filters) → ranked hits with snippets + citations
- [ ] Build lexical index over memory docs + selected session recaps:
      - FTS index fields: title, headings, tags, body, updated, path, kind
- [ ] Retrieval policy (wired into agent loop):
      - Before edits/tool execution: query memory store using task intent
      - Load top-k chunks into context (bounded)
      - Always include citations: file path + heading anchor + event ids
- [ ] Optional vector layer (config flag only):
      - embed semantic/procedural + selected episodic recaps
      - add similarity hits only when lexical confidence is low
- [ ] TUI:
      - “Memory hits” panel: results + reasons + quick open
- [ ] Slash commands:
      - `/memory search <q>`
      - `/memory pin <id>` (pin a doc/chunk into current context set)

See |SCHEMAS.txt| section |schemas-memory-store| for SQLite schema.

DoD:
- Memory search returns ranked results with provenance citations and paths.
- Index is rebuildable; no “mystery memory”.

--------------------------------------------------------------------------------
XII. MEMORY GARDENER  (CONSOLIDATION, DRIFT CONTROL, AND HYGIENE)    *agent-XII*
--------------------------------------------------------------------------------
Goal:
Prevent memory rot. Convert raw session history into small, stable, reusable
memory artifacts (facts, ADRs, playbooks), without losing provenance.

Tasks:
- [ ] Consolidation pipeline (“episodic → semantic/procedural”):
      - Inputs: `events.jsonl`, patch events, snapshots
      - Outputs:
          - update FACTS (stable commands + gotchas)
          - create/update ADR-lite entries (durable decisions)
          - update PLAYBOOKS (repeatable workflows)
          - write session recap in `memory/episodic/YYYY-MM/<session>.md`
- [ ] Hygiene rules:
      - de-dup facts (single canonical location)
      - enforce size limits on core
      - require provenance links on all durable claims
- [ ] Drift checks:
      - if repo changed since `last_verified_commit`, mark docs “stale”
- [ ] “Memory PR” workflow:
      - gardener emits patch queue items (“Update memory: …”)
      - user approves/rejects like any other diff
- [ ] Tests:
      - golden tests for deterministic outputs from identical inputs

See |SCHEMAS.txt| section |schemas-gardener| for config format.

DoD:
- Memory stays small + correct: consolidation and drift marking are automatic.

--------------------------------------------------------------------------------
XIII. TRAJECTORY + INSPECTOR (DEBUGGABLE “WHY” FOR MEMORY)          *agent-XIII*
--------------------------------------------------------------------------------
Goal:
Make it trivial to answer: “Why did the agent believe X?” by linking memory
assertions to the exact evidence in the session log and patch history.

Tasks:
- [ ] Standardize “trajectory view” extracted from `events.jsonl`
- [ ] Build inspector UI (TUI):
      - filter by tool, file, timestamp, risk class
      - jump: memory doc → provenance events → patch diff → affected file
- [ ] Require provenance backlinks:
      - every durable memory doc must cite event ids + patch ids

See |SCHEMAS.txt| section |schemas-events| for JSONL event format.

DoD:
- Inspector can trace any memory claim back to evidence events + diffs.

--------------------------------------------------------------------------------
XIV. MIXED-INITIATIVE COLLABORATION                                  *agent-XIV*
--------------------------------------------------------------------------------
When you work alongside the agent, it pauses, notices drift, and reconciles.

- [ ] Drift detection (mandatory gate at every step boundary):
      - compare repo snapshot IDs; if changed → stop and require reconcile
- [ ] "User right-of-way" state machine:
      - any keystroke/edit cancels generation or tool execution immediately
- [ ] Reconcile ritual (single predictable flow):
      1. summarize changed files/diffstat
      2. choose: update plan & continue / rebase pending patches / discard
      3. refresh context and revalidate plan before acting again
      - enhance with choice implications (teach trade-offs of each option)
      - first drift triggers brief explainer:
        "Agent paused - you edited files. Let's reconcile"
- [ ] File ownership rule:
      - files you touched become "user-owned"; agent needs explicit approval to
        modify them until reconcile completes
- [ ] Advisor mode toggle:
      - consultative suggestions only (maps to read-only/approval modes)[^3]
- [ ] TUI enhancements (moved from Section III):
      - History editing: "edit previous message / fork from point"
      - Esc-based rewind behavior

DoD:
- The agent never proceeds on stale assumptions after you fix something manually

--------------------------------------------------------------------------------
XV. EXTENSIBILITY + HARDENING                                         *agent-XV*
--------------------------------------------------------------------------------
Match the "pro tool" feel: pluggable integrations, automation entrypoints,
and regression tests for harness behaviors.

- [ ] MCP client:
      - load MCP servers from config, import tool schemas, route calls
      - respect approval/sandbox across MCP tools[^8]
- [ ] Web search tool:
      - either provider-native (Gemini tools) or shell-gated `web_search`
        equivalent
            - Mojeek API
            - Brave API
            - Tavily API
      - treat results as tool outputs and log them[^9]
- [ ] Non-interactive mode (`thunderus exec "…"`) like Codex's `exec`:
      - emits JSON (machine output) + writes JSONL session log[^3]
- [ ] "review agent" (second pass) like Codex `/review` flow[^3]
- [ ] Harness regression tests (golden scenarios):
      - interrupt mid-tool, drift+reconcile, patch conflict UI, approval gating
- [ ] TUI enhancements (moved from Section III):
      - Permissions pane in sidebar
      - toggle verbose action trace keybind
- [ ] Session-based teaching state:
      - persist "taught concepts" in session metadata
      - track which pedagogical hints have been shown
        (e.g., `taught: [patch_conflict, risky_command]`)
      - prevent repetitive hints across session lifecycle
      - expose teaching history in session events for debugging

DoD:
- A daily-driver harness: interactive + scriptable + extensible.


--------------------------------------------------------------------------------
XVI. PARKING LOT                                                     *agent-XVI*
--------------------------------------------------------------------------------

Session Recovery:
- Interactive session selection UI (list multiple sessions with metadata)
- Session search and filtering (by date, keyword, etc.)
- Session branching (fork from a previous session)
- Session export/import (share sessions between machines)
- Session metadata (title, tags, description)

--------------------------------------------------------------------------------
XVII. REFERENCES                                                    *agent-XVII*
--------------------------------------------------------------------------------

See |REFS.txt| for external resources, design inspirations, and footnotes.
