*ROADMAP.txt*                                       Coding Agent (Thunderus) MVP

CODING AGENT MVP                                                 *agent-harness*
================================================================================

See |VISION.txt| for design philosophy, core principles, and milestone targets.

--------------------------------------------------------------------------------
CONTENTS                                                      *roadmap-contents*
--------------------------------------------------------------------------------

     I. Repo Scaffold + Config + Session Store ................. |agent-I|
    II. Provider Harness...Execution Infrastructure ............ |agent-II|
   III. TUI Harness ............................................ |agent-III|
    IV. TUI + Agent + CLI Integration .......................... |agent-IV|
     V. Core Text Processing Tools ............................. |agent-V|
    VI. Approvals + Sandboxing (Shell-First, Still Safe) ....... |agent-VI|
   VII. Diff-First Editing + Git Integration ................... |agent-VII|
  VIII. Theming / UI ........................................... |agent-VIII|
    IX. Markdown + JSONL Hybrid VCS ............................ |agent-IX|
     X. TIERED MEMORY CORE + STORE ............................. |agent-X|
    XI. LONG-TERM MEMORY STORE + RETRIEVAL ..................... |agent-XI|
   XII. MEMORY GARDENER  ....................................... |agent-XII|
  XIII. TRAJECTORY + INSPECTOR ................................. |agent-XIII|
   XIV. MIXED-INITIATIVE COLLABORATION ......................... |agent-XIV|
    XV. EXTENSIBILITY .......................................... |agent-XV|
   XVI. HARDENING .............................................. |agent-XVI|
  XVII. TUI TESTING FRAMEWORK .................................. |agent-XVII|
 XVIII. FINAL UI LAYOUT & SPEC ................................. |agent-XVIII|
   XIX. PARKING LOT............................................. |agent-XIX|
    XX. REFERENCES ............................................. |agent-XX|

--------------------------------------------------------------------------------
I. REPO SCAFFOLD + CONFIG + SESSION STORE                              *agent-I*
--------------------------------------------------------------------------------
See section |2026-01-12| for changes made.
--------------------------------------------------------------------------------
II. PROVIDER HARNESS + MINIMAL INTERACTIVE TUI                        *agent-II*
--------------------------------------------------------------------------------
See section |2026-01-13| for changes made.
--------------------------------------------------------------------------------
III. TUI HARNESS                                                     *agent-III*
--------------------------------------------------------------------------------
See section |2026-01-15| for changes made.
--------------------------------------------------------------------------------
IV. TUI + AGENT + CLI INTEGRATION                                     *agent-IV*
--------------------------------------------------------------------------------
See section |2026-01-15| for changes made.
--------------------------------------------------------------------------------
V. CORE TEXT PROCESSING TOOLS                                          *agent-V*
--------------------------------------------------------------------------------
See section |2026-01-16| for changes made.
--------------------------------------------------------------------------------
VI. APPROVALS + SANDBOXING (SHELL-FIRST, STILL SAFE)                  *agent-VI*
--------------------------------------------------------------------------------
See section |2026-01-18| for changes made.
--------------------------------------------------------------------------------
VII. DIFF-FIRST EDITING + GIT INTEGRATION                            *agent-VII*
--------------------------------------------------------------------------------
See section |2026-01-19| for changes made.
--------------------------------------------------------------------------------
VIII. UI POLISH + THEMING                                           *agent-VIII*
--------------------------------------------------------------------------------
See section |2026-01-20| for changes made.
--------------------------------------------------------------------------------
IX. MARKDOWN + JSONL HYBRID VCS                                      *agent-IX*
--------------------------------------------------------------------------------
See section |2026-01-21| for changes made.
--------------------------------------------------------------------------------
X. TIERED MEMORY CORE + STORE (REPO-NATIVE, AUDITABLE)                 *agent-X*
--------------------------------------------------------------------------------
See section |2026-01-22| for changes made.
--------------------------------------------------------------------------------
XI. LONG-TERM MEMORY + RETRIEVAL (LEXICAL FIRST, VECTORS OPT-IN)      *agent-XI*
--------------------------------------------------------------------------------
See section |2026-01-22| for changes made.
--------------------------------------------------------------------------------
XII. MEMORY GARDENER  (CONSOLIDATION, DRIFT CONTROL, AND HYGIENE)    *agent-XII*
--------------------------------------------------------------------------------
Prevent memory rot. Convert raw session history into small, stable, reusable
memory artifacts (facts, ADRs, playbooks), without losing provenance.

Tasks:
- [x] Consolidation pipeline ("episodic → semantic/procedural"):
      - Inputs: `events.jsonl`, patch events, snapshots
      - Outputs:
          - update FACTS (stable commands + gotchas)
          - create/update ADR-lite entries (durable decisions)
          - update PLAYBOOKS (repeatable workflows)
          - write session recap in `memory/episodic/YYYY-MM/<session>.md`
- [x] Hygiene rules:
      - de-dup facts (single canonical location)
      - enforce size limits on core
      - require provenance links on all durable claims
- [x] Drift checks:
      - if repo changed since `last_verified_commit`, mark docs "stale"
- [x] "Memory PR" workflow:
      - gardener emits patch queue items ("Update memory: …")
      - user approves/rejects like any other diff
- [x] Tests:
      - golden tests for deterministic outputs from identical inputs

See |SCHEMAS.txt| section |schemas-gardener| for config format.

DoD:
- Memory stays small + correct: consolidation and drift marking are automatic.

--------------------------------------------------------------------------------
XIII. TRAJECTORY + INSPECTOR (DEBUGGABLE "WHY" FOR MEMORY)          *agent-XIII*
--------------------------------------------------------------------------------
Make it trivial to answer: "Why did the agent believe X?" by linking memory
assertions to the exact evidence in the session log and patch history.

Tasks:
- [x] Standardize "trajectory view" extracted from `events.jsonl`
- [x] Build inspector UI (TUI):
      - [x] filter by tool, file, timestamp, risk class
      - [x] jump: memory doc → provenance events → patch diff → affected file
- [x] Require provenance backlinks:
      - [x] every durable memory doc must cite event ids + patch ids

See |SCHEMAS.txt| section |schemas-events| for JSONL event format.

DoD:
- Inspector can trace any memory claim back to evidence events + diffs.

--------------------------------------------------------------------------------
XIV. MIXED-INITIATIVE COLLABORATION                                  *agent-XIV*
--------------------------------------------------------------------------------
When you work alongside the agent, it pauses, notices drift, and reconciles.

- [x] Drift detection (mandatory gate at every step boundary):
      - compare repo snapshot IDs; if changed → stop and require reconcile
      - SnapshotManager tracks git state for drift detection
      - DriftMonitor uses notify crate for real-time file system watching
- [x] "User right-of-way" state machine:
      - any keystroke/edit cancels generation or tool execution immediately
      - pause_token and CancelToken for immediate interruption
      - pause_generation() and is_paused() state management
- [x] Reconcile ritual (single predictable flow):
      1. summarize changed files/diffstat
      2. choose: update plan & continue / rebase pending patches / discard
      3. refresh context and revalidate plan before acting again
      - interactive options: Enter (continue), Esc (discard), q (stop)
      - first drift triggers brief explainer:
        "Agent paused - you edited files. Let's reconcile"
- [x] File ownership rule:
      - files you touched become "user-owned"; agent needs explicit approval to
        modify them until reconcile completes
      - should_block_tool_for_ownership() enforcement in agent_handling
      - Session.file_ownership HashMap tracks ownership
      - ownership cleared on reconcile_continue()
- [x] Advisor mode toggle:
      - consultative suggestions only (maps to read-only/approval modes)
      - Ctrl+A toggles between Auto and ReadOnly modes
      - implemented in normal_mode.rs line 228-229
- [ ] TUI enhancements:
      - History editing: "edit previous message / fork from point"
      - Esc-based rewind behavior

DoD:
- The agent never proceeds on stale assumptions after you fix something manually

--------------------------------------------------------------------------------
XV. EXTENSIBILITY (SKILLS + PLUGINS)                                  *agent-XV*
--------------------------------------------------------------------------------
Make Thunderus extensible via on-demand capabilities and custom plugins.
Inspired by Pi's Skills system and token-efficient design.

- [ ] Skills system (on-demand capability loading):
      - `.thunderus/skills/` directory structure
      - SKILL.md format with frontmatter (name, description)
      - `/skill:name` invocation
      - Agent auto-discovery based on task intent
- [ ] Extension points (Rust trait-based):
      - Custom tools via `ToolDefinition` trait
      - Custom commands via `CommandHandler` trait
      - Event hooks via `EventSubscriber` trait
- [ ] Plugin loading:
      - Static: compile-time registration
      - Dynamic: WASM or Lua for runtime loading (optional)
- [ ] Built-in extensions registry:
      - Move web_search to skill
      - Move fetch_url to skill
- [ ] MCP client (opt-in extension):
      - load MCP servers from config, import tool schemas, route calls
      - respect approval/sandbox across MCP tools[^8]

DoD:
- Skills load on-demand; custom tools can be registered without recompiling.

--------------------------------------------------------------------------------
XVI. HARDENING (TESTS + EXEC MODE)                                   *agent-XVI*
--------------------------------------------------------------------------------
Make Thunderus production-ready with regression tests and automation support.

- [ ] Harness regression tests (golden scenarios):
      - interrupt mid-tool, drift+reconcile, patch conflict UI, approval gating
- [ ] Non-interactive mode (`thunderus exec "…"`) like Codex's `exec`:
      - emits JSON (machine output) + writes JSONL session log[^3]
      - Exit codes for CI/CD integration
- [ ] "review agent" (second pass) like Codex `/review` flow[^3]:
      - Confidence scoring for changes
- [ ] Session-based teaching state:
      - persist "taught concepts" in session metadata
      - track which pedagogical hints have been shown
        (e.g., `taught: [patch_conflict, risky_command]`)
      - prevent repetitive hints across session lifecycle
      - expose teaching history in session events for debugging
- [ ] Error recovery:
      - Graceful degradation on tool failures
      - Automatic retry with backoff
      - User notification on repeated failures
- [ ] TUI enhancements:
      - Permissions pane in sidebar
      - toggle verbose action trace keybind

DoD:
- Test suite covers all critical paths; `exec` mode works reliably in CI.

--------------------------------------------------------------------------------
XVII. TUI TESTING FRAMEWORK                                         *agent-XVII*
--------------------------------------------------------------------------------
Ensure visual regression coverage and end-to-end stability for the TUI harness.
Prevent layout regressions and ensure the agent loop handles terminal events
correctly.

Tasks:
- [ ] Widget Snapshot Infrastructure:
      - Add `insta` dependency
      - Configure snapshot directory and CI checks
- [ ] Core Widget Component Tests:
      - Welcome Screen (static render)
      - Transcript Renderer (wrapping, colors)
      - Approval Panel (risk state UI)
- [ ] Behavioral Logic Tests:
      - Event handler (input -> action)
      - Session state transitions
- [ ] PTY Integration Tests (End-to-End):
      - Headless binary launch & quit
      - Resize handling smoke test

DoD:
- `cargo test` runs unit + snapshot tests.
- CI fails on unreviewed snapshot changes.
- At least 3 major widgets have golden snapshots.

--------------------------------------------------------------------------------
XVIII. FINAL UI LAYOUT & SPEC                                         *agent-XVIII*
--------------------------------------------------------------------------------
Implement the final "Opening" and "Agent" layouts based on designated design
artifacts, ensuring a premium, polished TUI experience.

Tasks:
- [ ] Implement Opening Layout (see `doc/DESIGN.txt` |design-layout|):
      - Clean, focused entry point
- [ ] Implement Agent Layouts (see `doc/DESIGN.txt` |design-layout|):
      - "Inspire actual agent" interactions
      - Sidebar / Context panels
- [ ] Verify TUI responsiveness and styling matches design intent
- [ ] Finalize `doc/DESIGN.txt` with observed patterns

DoD:
- UI matches the visual target of `doc/DESIGN.txt`.
- Spec and implementation overlap 100%.

--------------------------------------------------------------------------------
XIX. PARKING LOT                                                    *agent-XIX*
--------------------------------------------------------------------------------
Session Recovery:
- Interactive session selection UI (list multiple sessions with metadata)
- Session search and filtering (by date, keyword, etc.)
- Session branching (fork from a previous session)
- Session export/import (share sessions between machines)
- Session metadata (title, tags, description)

--------------------------------------------------------------------------------
XX. REFERENCES                                                      *agent-XX*
--------------------------------------------------------------------------------

See |REFS.txt| for external resources, design inspirations, and footnotes.
