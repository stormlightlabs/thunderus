*QA.txt*                                                    Thunderus User Flows
================================================================================

CURRENT IMPLEMENTATION STATUS                                 *user-flow-status*

This document describes user interaction flows for the current implementation
of Thunderus. It serves as a reference for QA and smoke testing.

Last updated: 2026-01-22

--------------------------------------------------------------------------------
CONTENTS
--------------------------------------------------------------------------------

   I. INITIAL SETUP....................................... |user-flow-setup|
  II. SESSION MANAGEMENT.................................. |user-flow-sessions|
 III. TUI INTERACTION..................................... |user-flow-tui|
  IV. SHELL COMMANDS & EDITOR............................. |user-flow-shell|
   V. SLASH COMMANDS...................................... |user-flow-slash|
  VI. SESSION FILES AND LOGS.............................. |user-flow-files|
 VII. ERROR HANDLING...................................... |user-flow-errors|

--------------------------------------------------------------------------------
I. INITIAL SETUP                                               *user-flow-setup*
--------------------------------------------------------------------------------

First Run (No Config)
---------------------
$ thunderus status

Expected:
- Warning: "Config not found at config.toml"
- Info: "Creating config from example..."
- Success: "Created config at config.toml. Please edit it with your settings."
- Error: "Please edit config.toml with your settings and run again"
- Exit code 1
- config.toml created with example configuration

Result:
- User must edit config.toml with their API keys and settings before proceeding

Edit Config
-----------
$ cat config.toml

Expected structure:
- default_profile setting
- [profiles.default] section with:
  - provider configuration (glm or gemini)
  - api_key, model, base_url
  - approval_mode (read-only, auto, full-access)
  - sandbox_mode (policy or off)
  - working_root path

After editing, verify:
$ thunderus status

Expected:
- Info: "Thunderus Status"
- Default profile displayed
- Available profiles listed with provider types
- No errors

--------------------------------------------------------------------------------
II. SESSION MANAGEMENT                                      *user-flow-sessions*
--------------------------------------------------------------------------------

Creating a Session
------------------
$ thunderus start

Expected:
- Info: "Creating .agent directory" (first time only)
- Info: "Creating session..."
- Session ID displayed (cyan color)
- Session directory path shown
- Success: "Session <id> started successfully"
- TUI launches with welcome message in transcript

Result:
- .agent/ directory created in working directory
  - .agent/sessions/<session-id>/ created
  - .agent/sessions/<session-id>/events.jsonl created
  - .agent/views/ directory created
- TUI displays welcome message with:
  * Session ID, working directory, profile name
  * Approval mode and sandbox mode status
  * Quick help: Ctrl+C to cancel, Esc to clear input

Session with Options
--------------------
$ thunderus start --dir /workspace
$ thunderus start --profile work

Expected:
- Working directory used if specified
- Profile loaded from config
- TUI launches with specified settings

With Verbose Flag
-----------------
$ thunderus --verbose start

Expected additional output:
- "Using config: <path>"
- "Available profiles: [...]"
- "Working directory: <path>"
- "Profile: <name>"
- "Provider: <type>"
- "Approval mode: <mode>"
- "Sandbox mode: <mode>"
- "Session ID: <id>"
- "Session directory: <path>"

Shell Completions
-----------------
$ thunderus completions bash > ~/.bash_completion.d/thunderus
$ thunderus completions zsh > ~/.zsh/completion/_thunderus
$ thunderus completions fish > ~/.config/fish/completions/thunderus.fish

Expected:
- Shell-specific completion script output
- Completions for commands: start, exec, status, completions
- Completions for flags: --config, --profile, --verbose, --dir

--------------------------------------------------------------------------------
III. TUI INTERACTION                                             *user-flow-tui*
--------------------------------------------------------------------------------

The TUI is now fully integrated with the CLI. Launching with `thunderus start`
opens the interactive TUI interface.

Layout Structure
----------------
Terminal width >= 100 columns (responsive layout):
┌─ Header ───────────────────────────────────────────────────────────┐
│ /workspace | @default | glm/glm-4.7 | auto | main | policy | std   │
└────────────────────────────────────────────────────────────────────┘
┌─ Sidebar ──┬─ Transcript ──────────────────────────────────────────┐
│            │                                                       │
│ Events     │ User messages, model responses, tool calls/results    │
│ Files      │ Syntax-highlighted code blocks                        │
│ Queue      │ Approval prompts (interactive)                        │
│            │                                                       │
│            │ Vertical scrolling supported                          │
└────────────┴───────────────────────────────────────────────────────┘
┌─ Footer ───────────────────────────────────────────────────────────┐
│ > [input buffer with cursor]                                       │
│ Status: Tokens used, approvals, tools executed                     │
│ Keybinds: Ctrl+C (quit/cancel) | Esc (clear input)                 │
└────────────────────────────────────────────────────────────────────┘

Narrow terminals: Sidebar auto-hides, maximizes transcript width.

Header Elements (responsive to terminal width):
- Working directory (cyan)
- Profile name (purple)
- Provider/model (blue)
- Approval mode (white/red)
- Git branch (green)
- Sandbox mode (yellow)
- Verbosity level (gray)

Input Flow
----------
1. Type message in composer (footer)
2. Press Enter to send (if not empty)
3. Message appears in transcript as "User: <message>"
4. Input buffer clears

Input Editing:
- Char input: Insert at cursor position
- Backspace: Delete char before cursor
- Delete: Delete char at cursor
- Left/Right arrows: Move cursor
- Home/End: Move to start/end
- Esc: Clear entire buffer

Message History Navigation
--------------------------
- Up arrow: Browse older messages
- Down arrow: Browse newer messages
- When navigating history:
  * Current draft saved temporarily
  * Position indicator shown: "(N/M)"
  * Can edit and resubmit past messages
- Start typing to reset navigation

Approval Flow
-------------
When tool execution requires approval:
1. Transcript shows approval prompt with:
   - Action description
   - Risk level (safe/risky/dangerous)
2. Footer shows keybind options:
   - Y: Approve action
   - N: Reject action
   - C: Cancel task
3. User presses key
4. Decision recorded in transcript
5. Tool execution continues or stops based on decision

Generation Control
------------------
While model is generating:
- Streaming tokens appear in real-time
- Ctrl+C: Cancel generation
- State indicator shows "generating"

Transcript Navigation
---------------------
- j / k: Navigate between cards or scroll transcript
- Ctrl+U: Page up in transcript
- Ctrl+D: Page down in transcript
- g: Jump to top of transcript
- G: Jump to bottom of transcript
- Transcript auto-scrolls to bottom on new entries

Multi-Level Detail Expansion
----------------------------
- Space / Enter: Expand/collapse focused card
- v: Toggle verbose mode for focused card
- Three detail levels:
  * Level 1 (default): Intent + outcome (brief, scannable)
  * Level 2 (expand): Detailed context, scope, execution metadata
  * Level 3 (verbose): Full logs, reasoning chain, trace

Sidebar Controls
----------------
- Ctrl+S: Toggle sidebar visibility
- [ / ]: Collapse/expand sidebar sections
- Sidebar sections (collapsible individually):
  * Session Events (chronological list with filtering)
  * Modified files list (scope awareness)
  * Git diff queue preview
  * LSPs & MCPs status (placeholders)

Action Shortcuts
----------------
- Ctrl+R: Retry last failed action
- /: Focus slash command input
- Ctrl+L: Clear transcript view (keep history)

Verbosity Modes
---------------
Three global verbosity levels:
- Quiet: Minimal output
- Default: Balanced (default)
- Verbose: Detailed output with all information

Toggle with keybind, persists per session. Indicator shown in header.

Theme Variants
--------------
Two visual themes are available:
- Iceberg: Cool blue palette (default)
- Oxocarbon: Dark carbon-based palette with warm accents

Theme selection persists per session. Both themes provide:
- Full background fills for all panels
- Styled message bubbles
- Animated streaming indicators
- Consistent color semantics across components

--------------------------------------------------------------------------------
IV. SHELL COMMANDS & EDITOR                                    *user-flow-shell*
--------------------------------------------------------------------------------

Shell Command Execution (!cmd)
------------------------------
In the composer, prefix with `!` to execute a shell command:

> !cargo test

Expected:
- Command executes in working directory
- Output captured and inserted as user-provided context
- Session event logged for shell execution
- Subject to approval/sandbox rules

Example output in transcript:
  Shell: cargo test
  ─────────────────
  running 42 tests
  test result: ok. 42 passed; 0 failed

External Editor (Ctrl+Shift+G)
------------------------------
Press Ctrl+Shift+G to open an external editor for complex prompts:

1. Press Ctrl+Shift+G
2. $VISUAL or $EDITOR opens with current input buffer
3. Edit content in external editor
4. Save and close editor
5. Content loaded back into composer
6. TUI redraws automatically

Note: Ctrl+G conflicts with tools like zellij, hence Ctrl+Shift+G is used.

Fuzzy File Finder (@)
---------------------
Type `@` in the composer to trigger the fuzzy file finder:

1. Type `@` at start of line or after space
2. Fuzzy finder overlay appears
3. Type to filter files (matching visible in real-time)
4. Up/Down arrows: Navigate file list
5. Enter: Insert selected file path
6. Esc: Close finder without selection

Features:
- Shows file preview before insertion
- Respects .gitignore
- Sorted by modification time

--------------------------------------------------------------------------------
V. SLASH COMMANDS                                              *user-flow-slash*
--------------------------------------------------------------------------------

Base Commands
-------------
/model [name]
  - Switch provider/model
  - Without argument: lists available models

/approvals [mode]
  - Change approval mode (read-only, auto, full-access)
  - Without argument: shows current mode and available options

/verbosity [level]
  - Change verbosity level (quiet, default, verbose)
  - Without argument: shows current level and available options

/status
  - Show session statistics:
    * Session ID
    * Working directory
    * Profile in use
    * Tokens used
    * Approvals gated
    * Tools executed

Plan Commands
-------------
/plan
  - Display PLAN.md content in transcript
  - Shows "No PLAN.md found" if file doesn't exist

/plan add <item>
  - Append a new item to PLAN.md
  - Creates PLAN.md if it doesn't exist
  - Adds with uncompleted checkbox: "- [ ] <item>"

/plan done <index>
  - Mark plan item as complete by 1-based index
  - Updates checkbox from "[ ]" to "[x]"
  - Shows error if index out of range

Memory Commands
---------------
/memory
  - Display MEMORY.md content in transcript
  - Shows "No MEMORY.md found" if file doesn't exist

/memory add <fact>
  - Add a new fact to core memory (FACTS.md)
  - Appends to facts list with timestamp and provenance

/memory search <query>
  - Full-text search across all memory documents
  - Uses SQLite FTS5 with BM25 ranking
  - Returns snippets with citations and relevance scores
  - Respects memory tier filtering (core > semantic > procedural > episodic)

/memory pin <id>
  - Pin a memory document for priority retrieval
  - Pinned documents appear in context automatically

Search Commands
---------------
/search <query> [scope: all|files|memory|patches]
  - Unified search across codebase and memory
  - Scopes:
    * all: search everything (default)
    * files: search project files only
    * memory: search memory documents only
    * patches: search patch queue and diffs
  - Results displayed in transcript with file paths and line numbers

Session Commands
----------------
/review
  - Trigger review pass
  - Currently placeholder: "Review functionality not yet implemented"

/clear
  - Clear transcript view (keeps session history)
  - Does not affect events.jsonl log

Unknown Commands
----------------
Unrecognized slash commands display:
  "Unknown command: /<command>. Type /help for available commands."

--------------------------------------------------------------------------------
VI. SESSION FILES AND LOGS                                     *user-flow-files*
--------------------------------------------------------------------------------

Directory Structure
------------------
.agent/
├── sessions/
│   └── <session-id>/
│       ├── events.jsonl        # Append-only event log
│       └── memory.db           # SQLite FTS5 memory store
├── views/                      # Materialized Markdown views
│   ├── PLAN.md                 # Active plan with checklist items
│   └── MEMORY.md               # Core memory facts and decisions
└── memory/                     # Tiered memory documents
    ├── core/                   # High-value, stable facts
    │   ├── FACTS.md            # Canonical facts about the project
    │   ├── DECISIONS.md        # ADR-lite decision records
    │   └── PLAYBOOKS.md        # Repeatable workflows
    ├── semantic/               # Entity-relationship knowledge
    ├── procedural/             # How-to knowledge
    └── episodic/               # Session recaps by date
        └── YYYY-MM/<session>.md

Memory Store
------------
Under the hood, memory documents are indexed in a SQLite database using FTS5
for full-text search with BM25 ranking:

- Lexical search: FTS5 virtual table with snippet extraction
- Vector search: Optional embeddings for semantic similarity (opt-in)
- Hybrid search: Combines lexical + vector when confidence is low
- Provenance: All memory entries cite source events and patches

Event Log Format
----------------
Each line in events.jsonl is a JSON object with:
- timestamp (ISO 8601)
- type (user_message, model_response, tool_call, shell_exec, etc.)
- payload (event-specific data)

Example:
{"timestamp":"2026-01-22T10:30:45Z","type":"user_message", \
 "payload":"Session started"}
{"timestamp":"2026-01-22T10:31:00Z","type":"shell_exec", \
 "payload":{"cmd":"cargo test","output":"..."}}

Reading Logs
------------
$ cat .agent/sessions/<session-id>/events.jsonl | jq
$ rg "user_message" .agent/sessions/

--------------------------------------------------------------------------------
VII. ERROR HANDLING                                            *user-flow-errors*
--------------------------------------------------------------------------------

Config Errors
-------------
Missing profile:
$ thunderus start --profile nonexistent

Expected:
- Error: "Failed to load profile 'nonexistent'"
- Exit code 1

Invalid TOML:
$ echo "invalid" > config.toml
$ thunderus status

Expected:
- Error: "Failed to load config: <parse error>"
- Exit code 1

Session Errors
--------------
Directory creation failure (permissions):
Expected:
- Error: "Failed to create .agent directory: <io error>"
- Exit code 1

Event log write failure:
Expected:
- Error: "Failed to log session start: <io error>"
- Exit code 1

TUI Errors
----------
Terminal restoration:
- On exit or error, terminal state is restored
- Panic hook disables raw mode and restores terminal

Shell command failure:
- Error message displayed in transcript
- Session continues normally

External editor not found:
- "Failed to open editor. Check $VISUAL or $EDITOR environment variables."
- Input buffer preserved
